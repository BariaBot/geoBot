# Техническое задание (ТЗ) — Telegram Mini App Dating Platform

## 1. Общие сведения
- **Название проекта:** WAU Dating Mini App.
- **Цель:** предоставить внутри Telegram Mini Apps свайповое приложение знакомств с эффектом «вау», стартуя на дешёвой инфраструктуре и сохраняя возможность масштабирования.
- **Заказчик:** внутренний продукт geoBot.
- **Команда:**
  - Product / Vision — TBD.
  - Backend Core (Spring/PostGIS) — существующая команда.
  - Mini App Gateway + Frontend — новая TypeScript команда.
  - DevOps/Infra — shared.
- **Сроки:** MVP — 8 недель, пилотный запуск — неделя 9, подготовка к миграции — неделя 12.
- **Дата актуальности:** 23.09.2025.

## 2. Область применения
Приложение работает как Telegram Mini App, доступное из Telegram-бота. Пользователи просматривают анкеты, свайпают, получают совпадения и могут покупать бусты/суперлайки за Stars с дальнейшей конверсией в Toncoin.

## 3. Термины и сокращения
- **Mini App** — Telegram WebApp, запускаемое внутри клиента Telegram.
- **initData** — пакет данных авторизации, передаваемый Telegram клиентом.
- **Stars** — внутренняя валюта Telegram для оплаты цифровых товаров.
- **TON Connect** — стандарт авторизации/подписания операций в сети TON.
- **DeviceStorage / SecureStorage** — клиентские хранилища в Mini Apps.

## 4. Ограничения и предпосылки
- Railway: до 3 сервисов и лимит ресурса; допускается запуск фронта, gateway и core в одном проекте.
- Санкции: AWS/Azure/GCP недоступны; долгосрочный хостинг — Selectel или Yandex Cloud.
- Telegram политика: обязательная поддержка Stars и TON Connect к 21.02.2025; соблюдение App Review.
- Бюджет MVP: ≤ $30 в месяц на инфраструктуру.
- Хранимые данные (PII) должны находиться в РФ или странах, разрешённых политикой компании.

## 5. Пользовательские роли и сценарии
### 5.1 Роли
- **Гость:** запускает Mini App, авторизуется через Telegram, заполняет профиль.
- **Базовый пользователь:** свайпает анкеты, получает матчи, использует бесплатные функции.
- **Премиум пользователь:** покупает бусты/суперлайки, использует расширенные фильтры (после MVP).
- **Оператор поддержки:** удаляет профили, откатывает платежи, отвечает на обращения.

### 5.2 Основные сценарии
1. Запуск Mini App → валидация initData → отображение onboarding.
2. Создание/редактирование профиля с загрузкой фото.
3. Настройка предпочтений (радиус, возраст, интересы).
4. Свайп ленты (like/dislike/superlike).
5. Получение совпадения (match) с уведомлением.
6. Покупка буста/суперлайка через Stars.
7. Подключение TON Connect (для расширенных функций).
8. Получение push-кампаний через бот (ре-энгейджмент).

## 6. Функциональные требования
### 6.1 MVP (Фазы 0–2)
- F1. Авторизация через initData: проверка подписи, TTL ≤ 5 минут, хранение сессии в Redis.
- F2. CRUD профиля: имя, возраст, био, интересы (до 10 тегов), медиа до 6 элементов.
- F3. Геолокация: добровольное предоставление; если отказ — fallback на город пользователя.
- F4. Свайп-листы: отдача кандидатов с учётом радиуса и предпочтений, 100 карточек в очередь.
- F5. Ведение очереди лайков/дизлайков, вычисление матчей при взаимном лайке.
- F6. Чат-заглушка: открыть диалог с ботом с предзаполненным сообщением.
- F7. Покупка буста/суперлайка: показ Paywall, подтверждение Stars, запись транзакции, применение эффекта (приоритет или повторное показ).
- F8. Админ-панель (CLI/API) для блокировки профилей и возврата покупок.

### 6.2 Post-MVP (Фазы 3–5)
- F9. WebSocket/SSE обновления статуса (новый матч, ответ).
- F10. Premium фильтры (доход в Stars) и Spotlight showcase.
- F11. Рекомендательные модели (ML) с возможностью A/B тестов.
- F12. Личный кабинет оператора (web) с журналами транзакций и обращений.

## 7. Системная архитектура (кратко)
- Мини приложение (React) ↔ Gateway (NestJS) ↔ Core (Spring Boot) ↔ PostGIS/Redis.
- Webhook-и Telegram и TON обрабатываются в Gateway, затем фиксируются в Core.
- Отдельная очередь (BullMQ) для отложенных задач (ежедневные подборы, рассылки).

## 8. API и интеграции
- REST/GraphQL между фронтом и Gateway; gRPC между Gateway и Core (опционально после MVP).
- Telegram Bot API: отправка push-сообщений и получение webhook-ов Payments/Stars.
- TON Connect SDK: обработка подключения кошелька, подписание транзакций.
- Analytics API (внутренний): события `profile_complete`, `swipe`, `match`, `payment_success`.

## 9. Данные и модели
- **PostGIS**
  - `profiles`: id, telegram_user_id, name, birthdate, bio, interests[], media_refs[], created_at, updated_at.
  - `locations`: profile_id, geom (POINT, SRID 4326), city, country, updated_at.
  - `likes`: id, from_profile_id, to_profile_id, type (like|superlike|dislike), created_at.
  - `matches`: id, profile_id_a, profile_id_b, status (active|closed), created_at.
  - `transactions`: id, profile_id, product (boost|superlike|subscription), stars_amount, ton_amount, status.
- **Redis**
  - `session:{telegramId}` → auth/session payload.
  - `queue:swipes:{profileId}` → pending candidates.
  - `geo:profiles` → GEOADD для быстрого поиска поблизости.
  - `rate:{profileId}` → rate limits (swipes/minute, purchases/day).

## 10. Интерфейсные требования
- Адаптация под fullscreen, safe-area, тёмную/светлую тему Telegram.
- Локализация RU/EN (JSON ресурсы). Переход к доп. языкам в Пост-MVP.
- Haptic feedback и анимации советуются, но допускается минимальный набор на MVP.

## 11. Нефункциональные требования
- Производительность: p95 отклик Gateway ≤150 мс, Core ≤250 мс при 5k RPS.
- Масштабирование: поддержка 2 млн DAU после миграции, подготовка к 20k RPS.
- Надёжность: SLA 99.5 %, MTTR ≤30 мин.
- Безопасность: TLS, подпись запросов, шифрование PII, аудит логинов/платежей, SOC2-ready (дальше).
- Privacy: удаление данных по запросу ≤30 дней, авто-удаление неактивных профилей через 12 месяцев.
- Бюджет/ресурсы: ограничить потребление CPU/RAM на Railway, мониторить еженедельно.

## 12. Монетизация
- Stars-пакеты для бустов/суперлайков; цена в Stars с динамическим перерасчётом.
- Конвертация Stars→Toncoin для вывода и Telegram Ads (учёт и отчётность в Core).
- В будущем — подписки и Spotlight, завязанные на TON Connect.

## 13. Аналитика и наблюдаемость
- Метрики: daily active users, swipe rate, match rate, конверсия в оплату, LTV.
- Логи: structured JSON, трассировка через OpenTelemetry.
- Алерты: Telegram канал `#alerts-miniapp` (критические-ошибки), `#ops-miniapp` (предупреждения).

## 14. Quality & Testing
- Unit-тесты: >70 % покрытие критического кода (gateway, core APIs).
- E2E: Playwright (Mini App UI + mocks Telegram) минимум 5 ключевых сценариев.
- Нагрузочные тесты: k6 (swipe, match, payment) перед миграцией на селектел/YC.
- Безопасность: регулярные зависимость-сканы (Dependabot), pentest перед фазой 4.

## 15. План релизов
- R0 (Week 4): закрытая бета MVP (функции F1–F7). 50 пользователей.
- R1 (Week 6): открытый MVP с монетизацией (F1–F8). 500 пользователей.
- R2 (Week 9): engagement update (F9) + push-кампании.
- R3 (Week 12): миграция в облако РФ, готовность к масштабированию.
- R4 (Week 16+): premium расширения (F10–F12).

## 16. Deliverables
- Исходный код репозиториев (`miniapp-frontend`, `miniapp-gateway`, `matching-core`).
- Инфраструктурные скрипты (Terraform, Helm/Compose).
- Документация: roadmap, ТЗ (текущий документ), deployment plan, runbooks, UX-гайды.
- Тестовые сценарии и отчёты (CI/CD). 

## 17. Критерии приёмки
- MVP соответствует функциональным требованиям F1–F7.
- Отклик и стабильность в пределах NFR.
- Stars покупки проходят end-to-end и отражаются в ledger.
- Документация и runbooks готовы, CI pipeline выполняет тесты.
- Инфраструктурные затраты на MVP не превышают лимит бюджета за первый месяц.

## 18. Приложения
- A. Схемы API (будут добавлены).
- B. UX wireframes (после дизайн-спринта).
- C. Terraform диаграмма (после подготовки инфраструктуры).
