package ru.gang.datingBot.handler;

import java.util.List;
import lombok.Setter;
import ru.gang.datingBot.bot.KeyboardService;
import ru.gang.datingBot.bot.MessageSender;
import ru.gang.datingBot.bot.ProfileService;
import ru.gang.datingBot.bot.UserStateManager;
import ru.gang.datingBot.model.MeetingRequest;
import ru.gang.datingBot.model.User;
import ru.gang.datingBot.service.MeetingService;
import ru.gang.datingBot.service.UserService;

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
 */
public class CallbackQueryHandler {

  private final UserService userService;
  private final MeetingService meetingService;
  private final UserStateManager stateManager;
  private final KeyboardService keyboardService;
  private final ProfileService profileService;
  private final MessageSender messageSender;
  
  @Setter
  private ChatHandler chatHandler; // –ù–µ –ø–µ—Ä–µ–¥–∞–µ–º –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ —Å–µ—Ç—Ç–µ—Ä
  
  @Setter
  private MeetingPlaceHandler meetingPlaceHandler;

  public CallbackQueryHandler(
          UserService userService,
          MeetingService meetingService,
          UserStateManager stateManager,
          KeyboardService keyboardService,
          ProfileService profileService,
          MessageSender messageSender) {
    this.userService = userService;
    this.meetingService = meetingService;
    this.stateManager = stateManager;
    this.keyboardService = keyboardService;
    this.profileService = profileService;
    this.messageSender = messageSender;
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
   */
  public void processCallbackQuery(Long chatId, String data, Integer messageId) {
    System.out.println("DEBUG: –ü–æ–ª—É—á–µ–Ω callback: " + data + " –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + chatId);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ—Ñ–∏–ª–µ–º
    if (data.startsWith("edit_profile_")) {
      String field = data.replace("edit_profile_", "");
      processProfileEdit(chatId, field, messageId);
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞
    if (data.startsWith("gender_")) {
      if (!data.startsWith("gender_pref_")) { // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª–∞
        String gender = data.replace("gender_", "");
        userService.updateUserGender(chatId, gender);

        try {
          messageSender.deleteMessage(chatId, messageId);
        } catch (Exception e) {
          System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
        }
        
        messageSender.sendTextMessage(chatId, "‚úÖ –í–∞—à –ø–æ–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: " + profileService.getGenderDisplay(gender));

        messageSender.sendTextMessage(chatId, "üì∏ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:");
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_PHOTO);
        return;
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ –ø–æ–ª—É
    if (data.startsWith("gender_pref_")) {
      String genderPref = data.replace("gender_pref_", "");

      User user = userService.getUserByTelegramId(chatId);
      userService.updateUserSearchPreferences(chatId, user.getMinAgePreference(), user.getMaxAgePreference(), genderPref);

      try {
        messageSender.deleteMessage(chatId, messageId);
      } catch (Exception e) {
        System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
      }
      
      messageSender.sendTextMessage(chatId, "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!\n\n" +
              "üîç –í–æ–∑—Ä–∞—Å—Ç: " + (user.getMinAgePreference() != null ? user.getMinAgePreference() : "–ª—é–±–æ–π") + 
              " - " + (user.getMaxAgePreference() != null ? user.getMaxAgePreference() : "–ª—é–±–æ–π") + " –ª–µ—Ç\n" +
              "üë• –ü–æ–ª: " + profileService.getGenderPreferenceDisplay(genderPref));

      stateManager.setUserState(chatId, UserStateManager.UserState.NONE);
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
    if (data.equals("1 —á–∞—Å") || data.equals("3 —á–∞—Å–∞") || data.equals("6 —á–∞—Å–æ–≤")) {
      int duration = Integer.parseInt(data.split(" ")[0]);
      stateManager.saveLocationDuration(chatId, duration);

      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
      try {
        messageSender.deleteMessage(chatId, messageId);
      } catch (Exception e) {
        System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
      }
      
      messageSender.sendTextMessage(chatId, "‚úÖ –í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ –ø–æ–∏—Å–∫ –ª—é–¥–µ–π —Ä—è–¥–æ–º –Ω–∞ " + duration + " —á–∞—Å–æ–≤.");

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä —Ä–∞–¥–∏—É—Å–∞
      messageSender.sendTextMessageWithKeyboard(
              chatId,
              "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞:",
              keyboardService.createRadiusSelectionKeyboard());
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞–¥–∏—É—Å–∞
    if (data.equals("1 –∫–º") || data.equals("3 –∫–º") || data.equals("5 –∫–º") || data.equals("1500 –∫–º")) {
      int radius = Integer.parseInt(data.split(" ")[0]);
      stateManager.saveSearchRadius(chatId, radius);

      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
      try {
        messageSender.deleteMessage(chatId, messageId);
      } catch (Exception e) {
        System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
      }
      
      messageSender.sendTextMessage(chatId, "üìç –í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ " + radius + " –∫–º.");

      // –ü—Ä–æ—Å–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
      messageSender.sendTextMessageWithKeyboard(
              chatId,
              "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, —á—Ç–æ–±—ã –≤–∞—Å –º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏:",
              keyboardService.createLocationRequestKeyboard());
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É
    if (data.startsWith("send_request_")) {
      Long receiverId = Long.parseLong(data.replace("send_request_", ""));
      stateManager.saveMeetingRequestTarget(chatId, receiverId);

      System.out.println("DEBUG: –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –æ—Ç " + chatId + " –∫ " + receiverId);
      
      try {
        messageSender.deleteMessage(chatId, messageId);
      } catch (Exception e) {
        System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
      }
      
      messageSender.sendTextMessage(chatId, "üìù –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É:");
      stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_MEETING_MESSAGE);
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (data.equals("next_user")) {
      showNextUser(chatId, messageId);
      return;
    }

    if (data.equals("prev_user")) {
      showPreviousUser(chatId, messageId);
      return;
    }
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—Ç–∞–º
    if (data.equals("next_place")) {
      meetingPlaceHandler.showNextPlace(chatId);
      return;
    }

    if (data.equals("prev_place")) {
      meetingPlaceHandler.showPreviousPlace(chatId);
      return;
    }

    // –í—ã–±–æ—Ä –º–µ—Å—Ç–∞
    if (data.startsWith("select_place_")) {
      Long placeId = Long.parseLong(data.replace("select_place_", ""));
      meetingPlaceHandler.processPlaceSelection(chatId, placeId);
      return;
    }

    // –í—ã–±–æ—Ä –¥–∞—Ç—ã
    if (data.startsWith("date_")) {
      String dateString = data.replace("date_", "");
      meetingPlaceHandler.processDateSelection(chatId, dateString);
      return;
    }

    // –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
    if (data.startsWith("time_")) {
      String timeString = data.replace("time_", "");
      meetingPlaceHandler.processTimeSelection(chatId, timeString);
      return;
    }

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏
    if (data.startsWith("confirm_meeting_")) {
      Long meetingRequestId = Long.parseLong(data.replace("confirm_meeting_", ""));
      meetingPlaceHandler.processConfirmation(chatId, meetingRequestId);
      return;
    }

    // –û—Ü–µ–Ω–∫–∞ –≤—Å—Ç—Ä–µ—á–∏
    if (data.startsWith("rate_meeting_")) {
      String[] parts = data.replace("rate_meeting_", "").split("_");
      if (parts.length == 2) {
        Long meetingRequestId = Long.parseLong(parts[0]);
        int rating = Integer.parseInt(parts[1]);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ü–µ–Ω–∫–∏ –≤—Å—Ç—Ä–µ—á–∏
        messageSender.sendTextMessage(chatId, "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É! –í–∞—à –æ—Ç–∑—ã–≤ –æ—á–µ–Ω—å –≤–∞–∂–µ–Ω –¥–ª—è –Ω–∞—Å.");
      }
      return;
    }

    // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É
    if (data.startsWith("accept_request_")) {
      Long senderId = Long.parseLong(data.replace("accept_request_", ""));
      Long receiverId = chatId;

      System.out.println("DEBUG: –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –æ—Ç " + senderId + " –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º " + receiverId);
      
      // –ù–∞—Ö–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å
      List<MeetingRequest> requests = meetingService.getPendingRequestsForUser(receiverId);
      for (MeetingRequest request : requests) {
        if (request.getSender().getTelegramId().equals(senderId)) {
          try {
            meetingService.acceptMeetingRequest(request.getId());
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –µ—Å–ª–∏ ChatHandler –¥–æ—Å—Ç—É–ø–µ–Ω
            if (chatHandler != null) {
              chatHandler.initializeChat(senderId, receiverId, request.getId());
            } else {
              // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ ChatHandler –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
              messageSender.sendTextMessage(senderId, "‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –±—ã–ª –ø—Ä–∏–Ω—è—Ç!");
              messageSender.sendTextMessage(chatId, "–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É!");
            }
            
            System.out.println("DEBUG: –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –æ—Ç " + senderId + " –ø—Ä–∏–Ω—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º " + receiverId);
          } catch (Exception e) {
            System.out.println("DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: " + e.getMessage());
            messageSender.sendTextMessage(chatId, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
          }
          break;
        }
      }
    }

    // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É
    if (data.startsWith("decline_request_")) {
      Long senderId = Long.parseLong(data.replace("decline_request_", ""));
      Long receiverId = chatId;

      System.out.println("DEBUG: –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –æ—Ç " + senderId + " –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º " + receiverId);
      
      // –ù–∞—Ö–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å
      List<MeetingRequest> requests = meetingService.getPendingRequestsForUser(receiverId);
      for (MeetingRequest request : requests) {
        if (request.getSender().getTelegramId().equals(senderId)) {
          try {
            meetingService.declineMeetingRequest(request.getId());
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
            messageSender.sendTextMessage(senderId, "‚ùå –í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω.");
            messageSender.sendTextMessage(chatId, "–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É.");
            System.out.println("DEBUG: –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É –æ—Ç " + senderId + " –æ—Ç–∫–ª–æ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º " + receiverId);
          } catch (Exception e) {
            System.out.println("DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: " + e.getMessage());
            messageSender.sendTextMessage(chatId, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
          }
          break;
        }
      }
    }
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
   */
  private void processProfileEdit(Long chatId, String field, Integer messageId) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    try {
      messageSender.deleteMessage(chatId, messageId);
    } catch (Exception e) {
      System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
    }

    switch (field) {
      case "description":
        messageSender.sendTextMessage(chatId, "üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ —Å–µ–±–µ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤):");
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_DESCRIPTION);
        break;

      case "interests":
        messageSender.sendTextMessage(chatId, "‚≠ê –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ —Å–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏ —Ö–æ–±–±–∏ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤):");
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_INTERESTS);
        break;

      case "age":
        messageSender.sendTextMessage(chatId, "üéÇ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç (—á–∏—Å–ª–æ –æ—Ç 18 –¥–æ 100):");
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_AGE);
        break;

      case "gender":
        messageSender.sendTextMessageWithKeyboard(
                chatId,
                "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                keyboardService.createGenderSelectionKeyboard());
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_GENDER);
        break;

      case "photo":
        messageSender.sendTextMessage(chatId, "üì∏ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:");
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_PHOTO);
        break;

      case "search":
        showSearchSettings(chatId);
        break;

      case "age_range":
        messageSender.sendTextMessage(chatId, "üéØ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ (—á–∏—Å–ª–æ –æ—Ç 18 –¥–æ 100):");
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_MIN_AGE);
        break;

      case "gender_pref":
        messageSender.sendTextMessageWithKeyboard(
                chatId,
                "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –ø–æ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞:",
                keyboardService.createGenderPreferenceKeyboard());
        stateManager.setUserState(chatId, UserStateManager.UserState.WAITING_FOR_GENDER_PREFERENCE);
        break;
    }
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞
   */
  private void showSearchSettings(Long chatId) {
    User user = userService.getUserByTelegramId(chatId);

    if (user == null) {
      messageSender.sendTextMessage(chatId, "‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /edit_profile, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.");
      return;
    }

    try {
      messageSender.sendTextMessage(chatId, profileService.formatSearchSettings(user));
    } catch (Exception e) {
      System.out.println("DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–∏—Å–∫–∞: " + e.getMessage());
      messageSender.sendTextMessage(chatId, "–í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞:\n" +
              "üéØ –í–æ–∑—Ä–∞—Å—Ç: " + (user.getMinAgePreference() != null ? user.getMinAgePreference() : "–ª—é–±–æ–π") + 
              " - " + (user.getMaxAgePreference() != null ? user.getMaxAgePreference() : "–ª—é–±–æ–π") + " –ª–µ—Ç\n" +
              "üë• –ü–æ–ª: " + user.getGenderPreferenceDisplay() + "\n" +
              "üìç –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: " + user.getSearchRadius() + " –∫–º");
    }

    messageSender.sendTextMessageWithKeyboard(
            chatId,
            "–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?",
            keyboardService.createSearchSettingsKeyboard());
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
   */
  private void showNextUser(Long chatId, Integer messageId) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try {
      messageSender.deleteMessage(chatId, messageId);
    } catch (Exception e) {
      System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
    }

    List<User> nearbyUsers = stateManager.getNearbyUsersCache(chatId);
    Integer currentIndex = stateManager.getCurrentUserIndex(chatId);

    if (nearbyUsers == null || nearbyUsers.isEmpty() || currentIndex == null) {
      messageSender.sendTextMessage(chatId, "‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.");
      return;
    }

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–∞—á–∞–ª—É
    currentIndex = (currentIndex + 1) % nearbyUsers.size();
    stateManager.setCurrentUserIndex(chatId, currentIndex);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    showCurrentNearbyUser(chatId);
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
   */
  private void showPreviousUser(Long chatId, Integer messageId) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try {
      messageSender.deleteMessage(chatId, messageId);
    } catch (Exception e) {
      System.out.println("DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: " + e.getMessage());
    }

    List<User> nearbyUsers = stateManager.getNearbyUsersCache(chatId);
    Integer currentIndex = stateManager.getCurrentUserIndex(chatId);

    if (nearbyUsers == null || nearbyUsers.isEmpty() || currentIndex == null) {
      messageSender.sendTextMessage(chatId, "‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.");
      return;
    }

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤ —Å–ø–∏—Å–∫–µ
    currentIndex = (currentIndex - 1 + nearbyUsers.size()) % nearbyUsers.size();
    stateManager.setCurrentUserIndex(chatId, currentIndex);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    showCurrentNearbyUser(chatId);
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
   */
  public void showCurrentNearbyUser(Long chatId) {
    List<User> nearbyUsers = stateManager.getNearbyUsersCache(chatId);
    Integer currentIndex = stateManager.getCurrentUserIndex(chatId);

    if (nearbyUsers == null || nearbyUsers.isEmpty()) {
      messageSender.sendTextMessageWithKeyboard(chatId,
              "üòî –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–∏–∫–æ–≥–æ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.\n\n" +
                      "üìç –£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–∞ " + stateManager.getLocationDuration(chatId) +
                      " —á–∞—Å–æ–≤. –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ–∫–∞–∂–µ—Ç—Å—è —Ä—è–¥–æ–º, –º—ã –≤–∞–º —Å–æ–æ–±—â–∏–º!",
              keyboardService.createMainKeyboard());
      return;
    }

    if (currentIndex == null || currentIndex < 0 || currentIndex >= nearbyUsers.size()) {
      currentIndex = 0;
      stateManager.setCurrentUserIndex(chatId, currentIndex);
    }

    User profile = nearbyUsers.get(currentIndex);
    System.out.println("DEBUG: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å " + profile.getTelegramId() + " –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + chatId);

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ñ–∏–ª–µ –≤ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
    String profileInfo = profileService.formatNearbyUserProfile(profile, currentIndex, nearbyUsers.size());

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ñ–∏–ª–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    messageSender.sendTextMessageWithKeyboard(
            chatId,
            profileInfo,
            keyboardService.createNearbyUserNavigationKeyboard(
                    profile.getTelegramId(),
                    nearbyUsers.size() > 1));

    // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ñ–æ—Ç–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ
    if (profile.getPhotoFileId() != null && !profile.getPhotoFileId().isEmpty()) {
      try {
        messageSender.sendPhoto(chatId, profile.getPhotoFileId(), null);
      } catch (Exception e) {
        System.out.println("DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è: " + e.getMessage());
      }
    }
  }
}
